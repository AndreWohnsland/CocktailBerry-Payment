name: Build & publish CocktailBerry images
run-name: "Version: ${{ github.event.release.tag_name }}, build and publish images"
on:
  release:
    types: [published]

jobs:
  build-exe:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: API
            certificate: CERTIFICATE_API
            password: CERTIFICATE_API_PW
          - service: GUI
            certificate: CERTIFICATE_GUI
            password: CERTIFICATE_GUI_PW

    env:
      PYI_NAME: cocktailberry-payment-${{ matrix.service }}

    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üîë Restore PFX certificate
        shell: pwsh
        env:
          PFX_BASE64: ${{ secrets[matrix.certificate] }}
          PFX_PASSWORD: ${{ secrets[matrix.password] }}
        run: |
          $bytes = [Convert]::FromBase64String($env:PFX_BASE64)
          $pfxPath = Join-Path $env:TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)

          $securePassword = ConvertTo-SecureString $env:PFX_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: üì¶ Install dependencies
        run: uv sync --all-extras

      - name: üõ†Ô∏è Build with PyInstaller
        run: uv run pyinstaller pyinstaller-${{ matrix.service }}.spec

      - name: üîè Sign EXE
        shell: pwsh
        run: |
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" `
            -Recurse -Filter signtool.exe | `
            Where-Object { $_.FullName -like "*x64*" } | `
            Select-Object -First 1 -ExpandProperty FullName
          & $signtool sign `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            /a `
            "dist/${{ env.PYI_NAME }}.exe"

      - name: üßπ Cleanup certificate
        if: always()
        shell: pwsh
        run: |
          $pfxPath = Join-Path $env:TEMP "codesign.pfx"
          if (Test-Path $pfxPath) { Remove-Item $pfxPath -Force }
          Get-ChildItem Cert:\CurrentUser\My | Remove-Item -Force -ErrorAction SilentlyContinue

      - name: üì§ Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PYI_NAME }}
          path: dist/${{ env.PYI_NAME }}.exe

      - name: üöÄ Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.PYI_NAME }}.exe
          asset_name: ${{ env.PYI_NAME }}.exe
          tag: ${{ github.event.release.tag_name }}

  build-and-push-docker-image:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./Dockerfile.api
            image: andrewo92/cocktailberry-payment-api
            context: "./"
    permissions:
      contents: read
      packages: write

    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v6

      - name: üê≥ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Log in to the Container registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üè∑Ô∏è Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: üç∏ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
