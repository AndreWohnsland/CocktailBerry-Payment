name: Update version, build & publish CocktailBerry images
run-name: "Version: ${{ github.event.release.tag_name }}, build and publish images"
on:
  release:
    types: [published]

jobs:
  build-exe:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: API
            certificate: CERTIFICATE_API
            password: CERTIFICATE_API_PW
          - service: GUI
            certificate: CERTIFICATE_GUI
            password: CERTIFICATE_GUI_PW

    env:
      PYI_NAME: cocktailberry-payment-${{ matrix.service }}

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”‘ Restore PFX certificate
        shell: pwsh
        run: |
          $pfxBase64 = "${{ secrets[matrix.certificate]}}"
          $pfxPassword = "${{ secrets[matrix.password]}}"

          $bytes = [Convert]::FromBase64String($pfxBase64)
          $pfxPath = "$env:TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)

          certutil -f -p $pfxPassword -importpfx $pfxPath

      - name: ğŸ Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: ğŸ“¦ Install dependencies
        run: uv sync --all-extras

      - name: ğŸ› ï¸ Build with PyInstaller
        run: uv run pyinstaller pyinstaller-${{ matrix.service }}.spec

      - name: ğŸ” Sign EXE
        shell: pwsh
        run: |
          signtool sign `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            /a `
            path\to\your.exe

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PYI_NAME }}
          path: dist/${{ env.PYI_NAME }}

      - name: ğŸš€ Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.PYI_NAME }}
          asset_name: ${{ env.PYI_NAME }}
          tag: ${{ github.event.release.tag_name }}

  build-and-push-docker-image:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./Dockerfile.api
            image: andrewo92/cocktailberry-payment-api
            context: "./"
    permissions:
      contents: read
      packages: write

    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v6

      - name: ğŸ³ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to the Container registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: ğŸ¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true
