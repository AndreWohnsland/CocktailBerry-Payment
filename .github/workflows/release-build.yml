name: Update version, build & publish CocktailBerry images
run-name: "Version: ${{ github.event.release.tag_name }}, build and publish images"
on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: API
            certificate: CERTIFICATE_API
            password: CERTIFICATE_API_PW
          - service: GUI
            certificate: CERTIFICATE_GUI
            password: CERTIFICATE_GUI_PW

    env:
      PYI_NAME: cocktailberry-payment-${{ matrix.service }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore PFX certificate
        shell: pwsh
        run: |
          $pfxBase64 = "${{ secrets[matrix.certificate]}}"
          $pfxPassword = "${{ secrets[matrix.password]}}"

          $bytes = [Convert]::FromBase64String($pfxBase64)
          $pfxPath = "$env:TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)

          certutil -f -p $pfxPassword -importpfx $pfxPath

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Build with PyInstaller
        run: uv run pyinstaller pyinstaller-${{ matrix.service }}.spec

      - name: Sign EXE
        shell: pwsh
        run: |
          signtool sign `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            /a `
            path\to\your.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PYI_NAME }}
          path: dist/${{ env.PYI_NAME }}

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.PYI_NAME }}
          asset_name: ${{ env.PYI_NAME }}
          tag: ${{ github.event.release.tag_name }}
