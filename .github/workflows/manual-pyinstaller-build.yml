name: Manual PyInstaller Build

on:
  workflow_dispatch:

jobs:
  build-exe:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: API
            certificate: CERTIFICATE_API
            password: CERTIFICATE_API_PW
          - service: GUI
            certificate: CERTIFICATE_GUI
            password: CERTIFICATE_GUI_PW

    env:
      PYI_NAME: cocktailberry-payment-${{ matrix.service }}

    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üîë Restore PFX certificate
        shell: pwsh
        env:
          PFX_BASE64: ${{ secrets[matrix.certificate] }}
          PFX_PASSWORD: ${{ secrets[matrix.password] }}
        run: |
          $bytes = [Convert]::FromBase64String($env:PFX_BASE64)
          $pfxPath = Join-Path $env:TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)

          $securePassword = ConvertTo-SecureString $env:PFX_PASSWORD -AsPlainText -Force
          Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: üì¶ Install dependencies
        run: uv sync --all-extras

      - name: üõ†Ô∏è Build with PyInstaller
        run: uv run pyinstaller pyinstaller-${{ matrix.service }}.spec

      - name: üîè Sign EXE
        shell: pwsh
        run: |
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" `
            -Recurse -Filter signtool.exe | `
            Where-Object { $_.FullName -like "*x64*" } | `
            Select-Object -First 1 -ExpandProperty FullName
          & $signtool sign `
            /fd SHA256 `
            /tr http://timestamp.digicert.com `
            /td SHA256 `
            /a `
            "dist/${{ env.PYI_NAME }}.exe"

      - name: üßπ Cleanup certificate
        if: always()
        shell: pwsh
        run: |
          $pfxPath = Join-Path $env:TEMP "codesign.pfx"
          if (Test-Path $pfxPath) { Remove-Item $pfxPath -Force }
          Get-ChildItem Cert:\CurrentUser\My | Remove-Item -Force -ErrorAction SilentlyContinue

      - name: üì§ Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.PYI_NAME }}
          path: dist/${{ env.PYI_NAME }}.exe
